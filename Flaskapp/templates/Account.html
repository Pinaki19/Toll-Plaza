{% extends "Base.html" %}
{% block title %}<title>Profile Page</title>{% endblock title %}
{% block Style_local %}
<link rel="stylesheet" type= "text/css" href= "{{ url_for('static',filename='css/Accounts.css') }}">
<script src="{{ url_for('static',filename='js/Profile.js') }}"></script>
{% endblock Style_local %}



{% block navContent %}
<a href="#" id='Logout' onclick="confirm_logout()" class="nav-item nav-link" style="margin-right:20px;">Log Out</a>
{% endblock navContent %}

{% block content %}
<div role='main' style="margin-top:80px;">
    <div class="container">
    <div class="main-body">
    
          <div class="row gutters-sm">
            <div class="col-md-4 mb-3">
              <div class="card">
                <div class="card-body" >
                  <div class="d-flex flex-column align-items-center text-center">
              
                    <!-- Edit Button -->
                    <button class="btn btn-secondary position-absolute top-1 end-0" id="editImageButton" style="background-color:#3e7eed;"><i class="bi bi-pencil-square"></i></button>
                    <input type="file" accept="image/*" style="display: none;" id="imageUploadInput">
                    <button class="btn btn-secondary position-absolute end-0" id="removeImageButton" style="top:60px; background-color:red;" onclick="Remove_Dp()"><i class="bi bi-trash3-fill"></i></button>
                    <img src="" alt="Profile image" class="rounded-circle" width="220" id="profileImage" style='outline:solid 2px black;'>
                     
                    <div class="mt-3">
                      <h4>{{ user.Name }}</h4>
                      {% if  user.IsSuperAdmin %}
                      <hr>
                      <h4 style='color:red;'>SUPER ADMIN</h4>

                      {% elif user.IsAdmin%}
                      <hr>
                      <h4 style='color:#f56c27;'>ADMIN</h4>
                      {% endif %}
                      
                    </div>
                        
                  </div>
                  
                </div>
                
              </div>
              <div class="card mt-3">
                <h4 class="list-group-item d-flex justify-content-between align-items-center" style="background:#f7e9c1;">Recents</h4>
                <ul class="list-group list-group-flush">
                  
                </ul>
              </div>
            </div>
            <div class="col-md-8">
              <div class="card mb-3">
                <div class="card-body" id="profileCardBody">
                  <div class="row">
                    <div class="col-sm-3">
                      <h6 class="mb-0">Full Name</h6>
                    </div>
                    <div class="col-sm-9 text-secondary" id="originalName">
                      {{ user.Name }}
                    </div>
                  </div>
                  <hr>
                  <div class="row">
                    <div class="col-sm-3">
                      <h6 class="mb-0">Email</h6>
                    </div>
                    <div class="col-sm-9 text-secondary" id="email">
                      {{ user.Email }}
                    </div>
                  </div>
                  <hr>
                  
                  <div class="row">
                    <div class="col-sm-3">
                      <h6 class="mb-0">Mobile</h6>
                    </div>
                    <div class="col-sm-9 text-secondary" id="originalMobile">
                      {{ user.Mobile }}
                    </div>
                  </div>
                  <hr>
                  <div class="row">
                    <div class="col-sm-3">
                      <h6 class="mb-0">Address</h6>
                    </div>
                    <div class="col-sm-9 text-secondary" id="originalAddress">
                      {{user.Address}}
                    </div>
                    
                  </div>
                  
                  <hr>
                  <div class="col-sm-15" style='text-align:right;' >
                        <a class="btn btn-info" onclick="editProfile()">Edit</a>
                    </div>
                  
                </div>
              </div>
          <div class="row gutters-sm" id="Content-Div" style="font-family:helvetica;">
              
            {% if  user.IsSuperAdmin %}
                <h4 style='color:red;'>SUPER ADMIN SECTION</h4>
                    <script>
                        show_super_admin_content();
                        show_admin_content();
                    </script>
                    <h4 style="color:#28dded">USER SECTION </h4>
                    <div class="col-sm-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="d-flex align-items-center mb-3" style="font-size:20px;">Your Wallet</h6>
                                <p style="padding-bottom:4px;margin-bottom:0;">Check Wallet transactions, Add Money, Reset PIN.</p>
                                {% if wallet.Default %}
                                <p id="Default_pin" style="padding:0;margin:0;color:red;padding-bottom:5px;">Default wallet PIN is 1234. Please change it.</p>
                                {% else %}
                                <p id="Default_pin" ></p>
                                {% endif %}
                                <!-- Input fields for new PIN and confirmation -->
                                <div id="ResetPinFields" style="display: none;padding:5px;">
                                  <input type="number" placeholder="Enter new PIN (4 digits)" id="NewPinInput" style="margin-right: 5px;" required maxlength="4">
                                  <input type="number" placeholder="Confirm new PIN" id="ConfirmPinInput" style="margin-right: 5px;" required maxlength="4">

                              </div>
                                <hr style="padding:0px;margin:0px;">
                                <p id="WalletBalance" style="padding:0;margin:0;position:absolute;top:11%;right:10%;color:blue">Balance: {{wallet.Balance}}</p>
                                <div style="margin-top:5px;padding:0px;text-align:right;">
                                    <a class="btn btn-primary btn-md" id="ResetPinButton" onclick="Reset()">Reset PIN</a>
                                    <a class="btn btn-primary btn-md" id="confirmButton" style="display:none;" >confirm</a>
                                    <a class="btn btn-secondary btn-md" id="cancelButton" style="display:none;" >cancel</a>
                                    <a class="btn btn-info btn-md" id="Gobutton" style="background-color:lightgreen;" data-bs-toggle="modal" data-bs-target="#walletModal">Go</a>
                                </div>
                            </div>
                        </div>
                </div>
              <script>
                show_user_content();
              </script>
            {% elif user.IsAdmin %}
              <script>
                  show_admin_content();
              </script>
              <h4 style="color:#28dded">USER SECTION </h4>
               <div class="col-sm-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="d-flex align-items-center mb-3" style="font-size:20px;">Your Wallet</h6>
                                <p style="padding-bottom:4px;margin-bottom:0;">Check Wallet transactions, Add Money, Reset PIN.</p>
                                {% if wallet.Default %}
                                <p id="Default_pin" style="padding:0;margin:0;color:red;padding-bottom:5px;">Default wallet PIN is 1234. Please change it.</p>
                                {% endif %}
                                <!-- Input fields for new PIN and confirmation -->
                                <div id="ResetPinFields" style="display: none;padding:5px;">
                                  <input type="number" placeholder="Enter new PIN (4 digits)" id="NewPinInput" style="margin-right: 5px;" required maxlength="4">
                                  <input type="number" placeholder="Confirm new PIN" id="ConfirmPinInput" style="margin-right: 5px;" required maxlength="4">

                              </div>
                                <hr style="padding:0px;margin:0px;">
                                <p id="WalletBalance" style="padding:0;margin:0;position:absolute;top:11%;right:10%;color:blue">Balance: {{wallet.Balance}}</p>
                                <div style="margin-top:5px;padding:0px;text-align:right;">
                                    <a class="btn btn-primary btn-md" id="ResetPinButton" onclick="Reset()">Reset PIN</a>
                                    <a class="btn btn-primary btn-md" id="confirmButton" style="display:none;" >confirm</a>
                                    <a class="btn btn-secondary btn-md" id="cancelButton" style="display:none;" >cancel</a>
                                    <a class="btn btn-info btn-md" id="Gobutton" style="background-color:lightgreen;" data-bs-toggle="modal" data-bs-target="#walletModal">Go</a>
                                </div>
                            </div>
                        </div>
                </div>
            <script>show_user_content()</script>

            {% else %}
            <h4 style="color:#28dded">USER SECTION </h4>
                <div class="col-sm-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="d-flex align-items-center mb-3" style="font-size:20px;">Your Wallet</h6>
                                <p style="padding-bottom:4px;margin-bottom:0;">Check Wallet transactions, Add Money, Reset PIN.</p>
                                {% if wallet.Default %}
                                <p id="Default_pin" style="padding:0;margin:0;color:red;padding-bottom:5px;">Default wallet PIN is 1234. Please change it.</p>
                                {% endif %}
                                <!-- Input fields for new PIN and confirmation -->
                                <div id="ResetPinFields" style="display: none;padding:5px;">
                                  <input type="number" placeholder="Enter new PIN (4 digits)" id="NewPinInput" style="margin-right: 5px;" required maxlength="4">
                                  <input type="number" placeholder="Confirm new PIN" id="ConfirmPinInput" style="margin-right: 5px;" required maxlength="4">

                              </div>
                                <hr style="padding:0px;margin:0px;">
                                <p id="WalletBalance" style="padding:0;margin:0;position:absolute;top:11%;right:10%;color:blue">Balance: {{wallet.Balance}}</p>
                                <div style="margin-top:5px;padding:0px;text-align:right;">
                                    <a class="btn btn-primary btn-md" id="ResetPinButton" onclick="Reset()">Reset PIN</a>
                                    <a class="btn btn-primary btn-md" id="confirmButton" style="display:none;" >confirm</a>
                                    <a class="btn btn-secondary btn-md" id="cancelButton" style="display:none;" >cancel</a>
                                    <a class="btn btn-info btn-md" id="Gobutton" style="background-color:lightgreen;" data-bs-toggle="modal" data-bs-target="#walletModal">Go</a>
                                </div>
                            </div>
                        </div>
                </div>
              <script>
                  show_user_content();
              </script>
            {% endif %}
              </div>
            </div>
          </div>

        </div>
    </div>


   <!-- Wallet Modal -->
<div class="modal fade" id="walletModal" tabindex="-1" aria-labelledby="walletModalLabel" aria-hidden="true" >
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background:#f9fae8;">
            <div class="modal-header">
                <h5 class="modal-title" id="walletModalLabel">User Wallet Information</h5>
            </div>
            <div class="modal-body" id="WalletBody" style="padding:25px;">
                <p id="CurrentBalance"><strong >Current Balance:</strong> &#8377;{{wallet.Balance}} </p>
                <p id="MaxBalance"><strong>Maximum Balance Cap: </strong>&#8377;50,000</p>
                <p id="Added"><strong>Total Added:</strong> &#8377;{{wallet.Added}}</p>
                <p id="Spent"> <strong>Total Spent:</strong> &#8377;{{wallet.Spent}}</p>
                <h6>Recent Transactions:</h6>
                {% include 'recent_transactions.html' %}
                <div id="AddMoneySection" style="display: none;">
                    <label for="amount">Enter Amount:</label>
                    <input type="number" id="amount" name="amount" min="1" required placeholder="Max 5000">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="toggleAddMoneySection()">Add Money</button>
                <button type="button" class="btn btn-primary" id="proceedButton" style="display: none;" onclick="processAddMoney()">Proceed</button>
            </div>
        </div>
    </div>
</div>


    <div class="modal fade" id="RecentModal" tabindex="-1" aria-labelledby="RecentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background:#fafae8;">
                <div class="modal-header">
                    <h5 class="modal-title" id="RecentModalLabel">All Recent Transactions</h5>
                   
                </div>
                <div class="modal-body" id="RecentModalbody" style="padding:25px;">
                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                   
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block scripts %}

<script type='text/javascript'>

    async function confirm_logout(){
        var result=confirm('You are about to log-out!');
        if (result){
            let response=await fetch('/Log_out');
            // Handle the response as needed
            if (response.status === 200 && response.redirected) {
                window.location.href=response.url;
            } else {
                alert("Log Out failed.");
            }
        }
    }

  async function load_profile() {
    try {
        // Fetch the user's profile image data from the server
        const response = await fetch("/get_profile_image");
        const data = await response.json();

        if (data.success && data.profile_url) {
            let imageURL;
            
            if (data.Default) {
                // If the user has a default profile picture, use the provided URL directly
                imageURL = data.profile_url;
            } else {
                // If the user has a custom profile picture, construct the image URL using the image_id
                imageURL = `/get_image/${data.profile_url}`;
               
            }
            
            
            // Set the user's profile image URL
            document.getElementById("profileImage").src = imageURL;
        }
        else{
          console.log(data);
        }
    } catch (error) {
        console.error("Error fetching profile image:", error);
    }
}


document.addEventListener('DOMContentLoaded',load_profile());

function editProfile() {
    // Get the reference to the card body element
    var cardBody = document.getElementById("profileCardBody");
    const headername = document.createElement("div");
    headername.setAttribute('id',"originalName");
    const headermob = document.createElement("div");
    headermob.setAttribute('id',"originalMobile");
    const headeradd = document.createElement("div");
    headeradd.setAttribute('id',"originalAddress");
    headername.innerText= document.getElementById("originalName").innerText;
    headermob.innerText = document.getElementById("originalMobile").innerText;
    headeradd.innerText = document.getElementById("originalAddress").innerText;
    
    // Create the new card body content
    var newCardBodyContent = `
        <div class="row mb-3">
            <div class="col-sm-3">
                <h6 class="mb-0">Full Name</h6>
            </div>
            <div class="col-sm-9 text-secondary">
                <input type="text" class="form-control" id="editName" value="{{user.Name}}">
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-sm-3">
                <h6 class="mb-0">Email</h6>
            </div>
            <div class="col-sm-9 text-secondary">
                <span id="email">{{user.Email}}</span>
            </div>
        </div>
        <!-- Add similar input fields for Phone, Mobile, and Address here -->
        <div class="row mb-3">
            <div class="col-sm-3">
                <h6 class="mb-0">Mobile</h6>
            </div>
            <div class="col-sm-9 text-secondary">
                <input type="text" class="form-control" id="editMobile" value="{{user.Mobile}}">
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-sm-3">
                <h6 class="mb-0">Address</h6>
            </div>
            <div class="col-sm-9 text-secondary">
                <input type="text" class="form-control" id="editAddress" value="{{user.Address}}">
            </div>
        </div>
        <div class="row">
            <div class="col-sm-3"></div>
            <div class="col-sm-9 text-secondary" style='text-align:right;'>
                <input type="button" class="btn btn-primary px-4" value="Save Changes" onclick='Save_data()'>
            </div>
        </div>
    `;

    // Replace the content of the card body with the new content
    cardBody.innerHTML = newCardBodyContent;
    document.head.appendChild(headername);
    document.head.appendChild(headermob);
    document.head.appendChild(headeradd);
}



function Save_data() {
  // Retrieve the edited name, address, and mobile number
  var editedName = document.getElementById("editName").value;
  var editedMobile = document.getElementById("editMobile").value;
  var editedAddress = document.getElementById("editAddress").value;
  var Email = document.getElementById("email").innerText;

 // Get the original data from the page
  var originalName = document.getElementById("originalName").innerText;
  var originalMobile = document.getElementById("originalMobile").innerText;
  var originalAddress = document.getElementById("originalAddress").innerText;

  // Check if any data has changed
  var dataChanged = false;

  if (editedName !== originalName) {
    dataChanged = true;
  }

  if (editedMobile !== originalMobile) {
    dataChanged = true;
  }

  if (editedAddress !== originalAddress) {
    dataChanged = true;
  }

  // If no data has changed, do not send a request
  if (!dataChanged) {
    //alert("No changes detected.");
    location.reload();
    return;
  }


  if(editedName.length<4 || editedName.length>40){
    alert("Name can have minimum of 4 and maximum of 40 characters.");
    return;
  }

  if (editedAddress.length > 100){
    alert("Address can have maximum of 100 characters.");
    return;
  }

  if(!validateMobile()){
    location.reload();
    return;
  }
  // Perform your desired action, such as sending data to the server
  // For example, you can use an AJAX request to send the data to your Flask endpoint:
  // Replace '/Edit_account' with your actual endpoint URL
  // You can send the data as a JSON object in the request body

  var data = {
    email:Email,
    name: editedName,
    mobile: editedMobile,
    address: editedAddress
  };

  // Send the data to the server
  fetch('/Edit_account', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  })
    .then(response => response.json())
    .then(data => {
      // Handle the response from the server if needed
     
      location.reload();
    })
    .catch(error => {
      // Handle any errors
      console.error(error);
      location.reload();
    });
    
}

// Get the elements
var profileImage = document.getElementById("profileImage");
var editImageButton = document.getElementById("editImageButton");
var imageUploadInput = document.getElementById("imageUploadInput");

// Add a click event listener to the edit button
editImageButton.addEventListener("click", function () {
    // Trigger the file input element to open the file dialog
    imageUploadInput.click();
});

// Add an event listener to handle image selection
imageUploadInput.addEventListener("change", function () {
    var file = imageUploadInput.files[0];
    if (file) {
        // Check if the file size is within the allowed limit (10 MB)
        if (file.size <= 10 * 1024 * 1024) {
            // Validate the file format (allow only image files)
            if (file.type.startsWith("image/")) {
                // Read and display the selected image
                var reader = new FileReader();
                reader.onload = function (e) {
                    profileImage.src = e.target.result;
                };
                reader.readAsDataURL(file);

                saveProfileImage(file);
            } else {
                alert("Please select a valid image file.");
            }
        } else {
            alert("File size exceeds the allowed limit (10 MB).");
        }
    }
});

function saveProfileImage(imageFile) {
    // Get the selected image file
    console.log(imageFile);
    
    if (!imageFile) {
        alert("Please select an image file.");
        return;
    }

    // Create a FormData object to send the file
    var formData = new FormData();
    formData.append("image", imageFile);

    // Send an AJAX POST request to the server to upload the image
    fetch("/upload_image", {
        method: "POST",
        body: formData,
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        if (data.success) {
            // Image uploaded successfully, you can update the UI or show a success message
            //alert("Image uploaded successfully!");
            //location.reload(); // Refresh the page or update the profile image element
        } else {
            // Handle the case where the upload failed
            alert("Image upload failed: " + data.message);
        }
    })
    .catch(function(error) {
        // Handle any errors that occur during the fetch
        console.error("Image upload error:", error);
    });
}


function Remove_Dp(){
  let result=confirm("You are about to Remove your Profile picture.")
  if(!result){
    return;
  }
  fetch("/remove_profile_image", {
        method: "POST",
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
       location.reload();
    })
    .catch(function(error) {
        // Handle any errors that occur during the fetch
        console.error("Profile picture removal error:", error);
    });

}

$('#walletModal').on('show.bs.modal', function (event) {
    $.ajax({
      url: '/get_recent_transactions',
      method: 'GET',
      success: function (data) {
          $('#RecentTransactions').html(data);
        },
      error: function (error) {
        console.error('Error fetching recent transactions:', error);
      }
    });
});


</script>

{% endblock scripts %}