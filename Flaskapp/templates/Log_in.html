<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log In</title>
    
    <link rel="stylesheet" type= "text/css" href= "{{ url_for('static',filename='css/Log_in.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://mdbcdn.b-cdn.net/wp-content/themes/mdbootstrap4/docs-app/css/dist/mdb5/standard/core.min.css">
    
    <link rel='stylesheet' id='roboto-subset.css-css' href='https://mdbcdn.b-cdn.net/wp-content/themes/mdbootstrap4/docs-app/css/mdb5/fonts/roboto-subset.css?ver=3.9.0-update.5'
        type='text/css' media='all' />

    <script src="{{ url_for('static',filename='js/scripts.js') }}"></script>

</head>
<body>

   <nav class="navbar navbar-expand-lg navbar-dark fixed-top" style="background-color:#000;">
    <div class="container-fluid">
        <a href="#" class="navbar-brand">Toll System</a>
        <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
        <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-between" id="navbarCollapse">
            <div class="navbar-nav">
                <a href="/" class="nav-item nav-link active">Home</a>
                <a href="/profile" class="nav-item nav-link">Profile</a>
                <div class="nav-item dropdown">
                    <a href="#Messages" id='MessagesToggle' class="nav-link dropdown-toggle" data-bs-toggle="dropdown">Messages</a>
                    <div class="dropdown-menu">
                        <a href="#" class="dropdown-item">Notifications</a>
                        <a href="#Query" class="dropdown-item" id='Query'>Ask a Query</a>
                    </div>
                </div>
            </div>
            
            <div class="navbar-nav">
                <a href="/Sign_up" id='Sign_up' class="nav-item nav-link" style="padding-right:30px">Sign Up</a>
                <form class="d-flex" style="padding-right:30px">
                    <div class="input-group" style="padding-top:5px; padding-right:20px;">
                        <input type="text" class="form-control" placeholder="Search" id="Search_bar" required>
                        <button type="submit" class="btn btn-secondary" onclick="search()"><i class="bi-search"></i></button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</nav>

    <div class="col d-flex justify-content-center ">
    
        <div class="card rounded-5 text-black justify-content-center align-items-center " id="Box">
            
            <div class="row g-0">
               
                    <div class="card-body p-md-2 mx-md-2">
    
                        <div class="text-center">
                                <h4 class="mt-1 mb-2 pb-1"><p>Please login to your account</p></h4>
                        </div>
    
                        <form>
                            
                            
                            <div class="form-outline mb-4" >
                            <input type="email" required  class="form-control" id="login_email" placeholder="Enter email address" />
                            
                            <label class="form-label" for="form2Example11"><i class="bi bi-envelope" style="color:rgb(231, 97, 25)"></i>Email ID</label>
                            </div>
                           
                            
                            <div class="form-outline mb-4" >
                            <input type="password" required class="form-control" id="login_password" placeholder="Enter password" />
                            <i class="bi bi-eye-slash-fill" id="eye"  onclick="show_hide()" ></i>
                            <label class="form-label" for="form2Example22"><i class="bi bi-lock-fill" style="color:rgb(218, 107, 28)"></i>Password</label>
                            
                            </div>
                            
                            <div class="text-center pt-1 mb-5 pb-1">
                            <button class="btn btn-primary btn-block fa-lg gradient-custom-2 mb-3" type="submit" id="login">Login</button>
                            <a class="text" id="Forgot_Pass" href="#" >Forgot password?</a>
                            </div>
        
                            <div class="d-flex align-items-center justify-content-center pb-4">
                                <p class="mb-0 me-2">Don't have an account?</p>
                                <a href="/Sign_up">
                                <button type="button" class="btn btn-outline-danger" id="Create" style="">Create new</button></a>
                            </div>
                        </form>
    
                    </div>
                
                                
            </div>
        </div>

    </div>
 <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</body>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-analytics.js";
    import { getAuth, fetchSignInMethodsForEmail, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js";
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyAAJ4Cv2d6cSSbRmnWQPll4kG4TvjdF-W8",
            authDomain: "smooth-sailing-ad0d5.firebaseapp.com",
            projectId: "smooth-sailing-ad0d5",
            storageBucket: "smooth-sailing-ad0d5.appspot.com",
            messagingSenderId: "62968749843",
            appId: "1:62968749843:web:3bbe8560b1e73c0a3244e6",
            measurementId: "G-E6EFBYWRML"
        };
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth();
    console.log(app);

    // ----- Login code start
        var flag = 1;
        var Username;

        document.getElementById("Forgot_Pass").addEventListener("click", async function () {
            var Provided;
            var email = document.getElementById("login_email").value;
            if(email){
                Provided=email;
            }
            else{
                Provided = window.prompt("Enter Your Email to Reset your password:");}
            var errorMessage;
            if (Provided != "" && Provided != null) {
                if (ValidateEmail(Provided)) {
                    console.log(localStorage.getItem("Password_reset_req"));
                    if (localStorage.getItem("Password_reset_req") == null)
                        localStorage.setItem("Password_reset_req", "0");
                    else {
                        localStorage.setItem("Password_reset_req", String(parseInt(localStorage.getItem("Password_reset_req")) + 1));
                    }
                    if (parseInt(localStorage.getItem("Password_reset_req")) <= 10) {
                        
                        var requestBody = {
                            Email: Provided.toLowerCase(),
                        };
                        var content = JSON.stringify(requestBody);

                        let response=await fetch("http://127.0.0.1:8080/Find_user", {
                            method: "POST",
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: content,
                        });
                        if(response.status===200){
                            try {
                                // User exists, send the password reset email
                                await sendPasswordResetEmail(auth, Provided);
                                // Password reset email sent successfully
                                alert("Password reset email sent. Check your inbox.");
                            } catch (error) {
                                alert("Error sending password reset email: " + error.message);
                            }
                        }else{
                            alert("No user with specified Email exists!!");
                        }
                         
                        
                    } else {
                        alert("Reset Quota Exceeded! Contact us for further Assistance");
                    }
                } else {
                    alert("Enter a valid Email.");
                }
            } 
        });
    document.getElementById("login").addEventListener("click", async function () {
        event.preventDefault();
        var email = document.getElementById("login_email").value;
        var password = document.getElementById("login_password").value;

        // Check if email and password are not empty
        if (!email || !password) {
            alert("Email and password are required.");
            return;
        }

        // Validate email format
        if (!await ValidateEmail(email)) {
            alert("Enter a valid email address.");
            return;
        }

        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;
            var verification_status = user.emailVerified;
            await signOut(auth);
            await fn(verification_status, auth, email, password, signInWithEmailAndPassword, user);
        } catch (error) {
            
            alert(error);
        }
    });
// ----- End



</script>
<script type="text/javascript">

    async function fn(verification_status, auth, email, password, signInWithEmailAndPassword, user) {
            if (verification_status) {
                localStorage.removeItem("Password_reset_req");
                signInWithEmailAndPassword(auth, email, password)
                    .then( (userCredential) => {
                        
                        fetchUserData(email); // Call fetchUserData after successful login
                    })
                    .catch((error) => {
                        console.error("There was a problem with sign in:", error);
                    });
            } else {
                alert("Please Verify your Email to Log In!");
                localStorage.setItem("Log In Status", false);
            }
    }

    async function fetchUserData(email) {
            try {
                // Make a POST request to fetch user data from the Flask server
                const response = await fetch("http://127.0.0.1:8080/Get_user_details", {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ Email: email.toLowerCase() }),
                });

                if (response.status === 200) {
                    sendEmailToLoginRoute(email);
                    
                } else {
                    // Handle the case where the POST request fails
                    alert("Failed to fetch user data.");
                }
            } catch (error) {
                console.error("There was a problem with the fetch operation:", error);
            }
    }



    async function sendEmailToLoginRoute(email) {
            try {
                // Make a POST request to the Flask login route with the email
                const response = await fetch("http://127.0.0.1:8080/login", {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email: email.toLowerCase() }),
                });

                // Handle the response as needed
                if (response.status === 200) {
                   window.location.href='/profile';
                } else {
                    alert("Login failed.");
                }
            } catch (error) {
                console.error("There was a problem with the fetch operation:", error);
            }
    }


    function ValidateEmail(input) {
            var validRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/;

            if (input.match(validRegex)) {
                return true;
            } 
            else {
                return false;
            }

    }

    function show_hide(){
        var element=document.getElementById("login_password");
        var element_type=element.getAttribute("type");
        if(element_type=="password"){
            element.setAttribute("type","text");
            document.getElementById("eye").setAttribute("class","bi bi-eye-fill");
        }
        else{
            element.setAttribute("type", "password");
            document.getElementById("eye").setAttribute ("class","bi bi-eye-slash-fill");
        }
    }
    
</script>

</html>